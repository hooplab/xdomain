// XDomain - v0.6.17 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2015
(function(a,b){(function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};r=a.document,d="before",c="after",l="readyState",k="addEventListener",j="removeEventListener",g="dispatchEvent",o="XMLHttpRequest",h="FormData",m=["load","loadend","loadstart"],e=["progress","abort","error","timeout"],u=parseInt((/msie (\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1]),isNaN(u)&&(u=parseInt((/trident\/.*; rv:(\d+)/.exec(navigator.userAgent.toLowerCase())||[])[1])),(y=Array.prototype).indexOf||(y.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),w=function(a,b){return Array.prototype.slice.call(a,b)},q=function(a){return"returnValue"===a||"totalSize"===a||"position"===a},t=function(a,b){var c,d;for(c in a)if(d=a[c],!q(c))try{b[c]=a[c]}catch(e){}return b},v=function(a,b,c){var d,e,f,h;for(e=function(a){return function(d){var e,f,h;e={};for(f in d)q(f)||(h=d[f],e[f]=h===b?c:h);return c[g](a,e)}},f=0,h=a.length;h>f;f++)d=a[f],b["on"+d]=e(d)},s=function(a){var b;if(null!=r.createEventObject)return b=r.createEventObject(),b.type=a,b;try{return new Event(a)}catch(c){return{type:a}}},f=function(a){var c,d,e;return d={},e=function(a){return d[a]||[]},c={},c[k]=function(a,c,f){d[a]=e(a),d[a].indexOf(c)>=0||(f=f===b?d[a].length:f,d[a].splice(f,0,c))},c[j]=function(a,c){var f;return a===b?void(d={}):(c===b&&(d[a]=[]),f=e(a).indexOf(c),void(-1!==f&&e(a).splice(f,1)))},c[g]=function(){var d,f,g,h,i,j,k,l;for(d=w(arguments),f=d.shift(),a||(d[0]=t(d[0],s(f))),h=c["on"+f],h&&h.apply(b,d),l=e(f).concat(e("*")),g=j=0,k=l.length;k>j;g=++j)i=l[g],i.apply(b,d)},a&&(c.listeners=function(a){return w(e(a))},c.on=c[k],c.off=c[j],c.fire=c[g],c.once=function(a,b){var d;return d=function(){return c.off(a,d),b.apply(null,arguments)},c.on(a,d)},c.destroy=function(){return d={}}),c},x=f(!0),x.EventEmitter=f,x[d]=function(a,b){if(a.length<1||a.length>2)throw"invalid hook";return x[k](d,a,b)},x[c]=function(a,b){if(a.length<2||a.length>3)throw"invalid hook";return x[k](c,a,b)},x.enable=function(){a[o]=n},x.disable=function(){a[o]=x[o]},p=x.headers=function(a,b){var c,d,e,f,g,h,i,j,k;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)g=a[e],f=e.toLowerCase(),d.push(""+f+":	"+g);return d.join("\n");case"string":for(d=a.split("\n"),i=0,j=d.length;j>i;i++)c=d[i],/([^:]+):\s*(.+)/.test(c)&&(f=null!=(k=RegExp.$1)?k.toLowerCase():void 0,h=RegExp.$2,null==b[f]&&(b[f]=h));return b}},i=a[h],i&&(x[h]=i,a[h]=function(a){var b;this.fd=a?new i(a):new i,this.form=a,b=[],Object.defineProperty(this,"entries",{get:function(){var c;return c=a?w(a.querySelectorAll("input,select")).filter(function(a){var b;return"checkbox"!==(b=a.type)&&"radio"!==b||a.checked}).map(function(a){return[a.name,"file"===a.type?a.files:a.value]}):[],c.concat(b)}}),this.append=function(a){return function(){var c;return c=w(arguments),b.push(c),a.fd.append.apply(a.fd,c)}}(this)}),x[o]=a[o],n=a[o]=function(){var b,i,j,n,q,r,s,w,y,A,B,C,D,E,F,G,H;return b=-1,H=new x[o],A={},D=null,r=void 0,E=void 0,B=void 0,y=function(){var a,c,d,e;if(B.status=D||H.status,D===b&&10>u||(B.statusText=H.statusText),D!==b){e=p(H.getAllResponseHeaders());for(a in e)d=e[a],B.headers[a]||(c=a.toLowerCase(),B.headers[c]=d)}},w=function(){"responseText"in H&&(B.text=H.responseText),"responseXML"in H&&(B.xml=H.responseXML),"response"in H&&(B.data=H.response)},G=function(){q.status=B.status,q.statusText=B.statusText},F=function(){"text"in B&&(q.responseText=B.text),"xml"in B&&(q.responseXML=B.xml),"data"in B&&(q.response=B.data)},n=function(a){for(;a>i&&4>i;)q[l]=++i,1===i&&q[g]("loadstart",{}),2===i&&G(),4===i&&(G(),F()),q[g]("readystatechange",{}),4===i&&setTimeout(j,0)},j=function(){r||q[g]("load",{}),q[g]("loadend",{}),r&&(q[l]=0)},i=0,C=function(a){var b,d;return 4!==a?void n(a):(b=x.listeners(c),d=function(){var a;return b.length?(a=b.shift(),2===a.length?(a(A,B),d()):3===a.length&&A.async?a(A,B,d):d()):n(4)},void d())},q=A.xhr=f(),H.onreadystatechange=function(){try{2===H[l]&&y()}catch(a){}4===H[l]&&(E=!1,y(),w()),C(H[l])},s=function(){r=!0},q[k]("error",s),q[k]("timeout",s),q[k]("abort",s),q[k]("progress",function(){3>i?C(3):q[g]("readystatechange",{})}),v(e,H,q),("withCredentials"in H||x.addWithCredentials)&&(q.withCredentials=!1),q.status=0,q.open=function(a,b,c,d,e){i=0,r=!1,E=!1,A.headers={},A.headerNames={},A.status=0,B={},B.headers={},A.method=a,A.url=b,A.async=c!==!1,A.user=d,A.pass=e,C(1)},q.send=function(b){var c,e,f,g,i,j,k,l;for(l=["type","timeout","withCredentials"],j=0,k=l.length;k>j;j++)e=l[j],f="type"===e?"responseType":e,f in q&&(A[e]=q[f]);A.body=b,i=function(){var b,c,d,g,i,j;for(E=!0,H.open(A.method,A.url,A.async,A.user,A.pass),i=["type","timeout","withCredentials"],d=0,g=i.length;g>d;d++)e=i[d],f="type"===e?"responseType":e,e in A&&(H[f]=A[e]);j=A.headers;for(b in j)c=j[b],H.setRequestHeader(b,c);a[h]&&A.body instanceof a[h]&&(A.body=A.body.fd),H.send(A.body)},c=x.listeners(d),(g=function(){var a,b;return c.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof B.status?void g():(t(a,B),z.call(a,"data")<0&&(a.data=a.response||a.text),void C(4))},a.head=function(a){return t(a,B),C(2)},a.progress=function(a){return t(a,B),C(3)},b=c.shift(),1===b.length?a(b(A)):2===b.length&&A.async?b(A,a):a()):i()})()},q.abort=function(){D=b,E?H.abort():q[g]("abort",{})},q.setRequestHeader=function(a,b){var c,d;c=null!=a?a.toLowerCase():void 0,d=A.headerNames[c]=A.headerNames[c]||a,A.headers[d]&&(b=A.headers[d]+", "+b),A.headers[d]=b},q.getResponseHeader=function(a){var b;return b=null!=a?a.toLowerCase():void 0,B.headers[b]},q.getAllResponseHeaders=function(){return p(B.headers)},H.overrideMimeType&&(q.overrideMimeType=function(){return H.overrideMimeType.apply(H,arguments)}),H.upload&&(q.upload=A.upload=f(),v(e.concat(m),H.upload,q.upload)),q},"function"==typeof this.define&&this.define.amd?define("xhook",[],function(){return x}):(this.exports||this).xhook=x}).call(this,a);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;F=null,h=function(a){var b,c;null===F&&(F={},t());for(b in a)c=a[b],z("adding slave: "+b),F[b]=c},p={},q=function(a,b){var c;return p[a]?p[a]:(c=m.createElement("iframe"),c.id=c.name=r(),z("creating iframe "+c.id),c.src=""+a+b,c.setAttribute("style","display:none;"),m.body.appendChild(c),p[a]=c.contentWindow)},t=function(){var a,b,c;return b=function(a,b){var c,d,e,f,g;return e=a[0],f=a[1],c=v(f,"Blob"),d=v(f,"File"),c||d?(g=new FileReader,g.onload=function(){return a[1]=null,d&&(a[2]=f.name),b(["XD_BLOB",a,this.result,f.type])},g.readAsArrayBuffer(f),1):0},a=function(a,c){var d;a.forEach(function(b,c){var d,e,f,g,h;if(e=b[0],f=b[1],v(f,"FileList"))for(a.splice(c,1),g=0,h=f.length;h>g;g++)d=f[g],a.splice(c,0,[e,d])}),d=0,a.forEach(function(e,f){d+=b(e,function(b){a[f]=b,0===--d&&c()})}),0===d&&c()},c=function(b,c){var d,e,f;return c.on("xhr-event",function(){return b.xhr.dispatchEvent.apply(null,arguments)}),c.on("xhr-upload-event",function(){return b.xhr.upload.dispatchEvent.apply(null,arguments)}),e=J(b),e.headers=b.headers,b.withCredentials&&(e.credentials=m.cookie),f=function(){return c.emit("request",e)},b.body&&(e.body=b.body,v(e.body,"FormData"))?(d=e.body.entries,e.body=["XD_FD",d],void a(d,f)):void f()},"addWithCredentials"in N||(N.addWithCredentials=!0),N.before(function(a,b){var d,e,f;return e=D(a.url),e&&e.origin!==l?F[e.origin]?(z("proxying request to slave: '"+e.origin+"'"),a.async===!1?(L("sync not supported"),b()):(d=q(e.origin,F[e.origin]),f=i(d),f.on("response",function(a){return b(a),f.close()}),a.xhr.addEventListener("abort",function(){return f.emit("abort")}),void(f.ready?c(a,f):f.once("ready",function(){return c(a,f)})))):(e&&z("no slave matching: '"+e.origin+"'"),b()):b()})},B=null,g=function(a){var b,c;null===B&&(B=[],u());for(b in a)c=a[b],z("adding master: "+b),a={origin:b,path:c},B.push(a)},f=function(a,b){var c;c={},c[a]=b,g(c)},u=function(){return x(function(a,b){"null"===a&&(a="*"),b.once("request",function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(m=null,z("request: "+c.method+" "+c.url),k=D(c.url),q=0,s=B.length;s>q;q++){l=B[q],i=l.origin,n=l.path;try{if(j=K(i),j.test(a)){if(m=K(n),!m.test(k.path))continue;break}}catch(v){}}if(!m)return void L("blocked request from: '"+a+"'");if(!k||!m.test(k.path))return L("blocked request to path: '"+k.path+"' by regex: "+m),void b.close();p=new XMLHttpRequest,p.open(c.method,c.url),p.addEventListener("*",function(a){return b.emit("xhr-event",a.type,J(a))}),p.upload&&p.upload.addEventListener("*",function(a){return b.emit("xhr-upload-event",a.type,J(a))}),b.once("abort",function(){return p.abort()}),p.onreadystatechange=function(){var a;if(4===p.readyState){a={status:p.status,statusText:p.statusText,data:p.response,headers:N.headers(p.getAllResponseHeaders())};try{a.text=p.responseText}catch(c){}return b.emit("response",a)}},c.withCredentials&&(c.headers["XDomain-Cookie"]=c.credentials),c.timeout&&(p.timeout=c.timeout),c.type&&(p.responseType=c.type),u=c.headers;for(h in u)o=u[h],p.setRequestHeader(h,o);if(c.body instanceof Array&&"XD_FD"===c.body[0]){for(g=new N.FormData,f=c.body[1],r=0,t=f.length;t>r;r++)d=f[r],"XD_BLOB"===d[0]&&4===d.length&&(e=new Blob([d[2]],{type:d[3]}),d=d[1],d[1]=e),g.append.apply(g,d);c.body=g}p.send(c.body||null)}),z("slave listening for requests on socket: "+b.id)}),a===a.parent?L("slaves must be in an iframe"):a.parent.postMessage("XDPING_"+d,"*")},C=function(b){return m.addEventListener?a.addEventListener("message",b):a.attachEvent("onmessage",b)},e="XD_CHECK",s=null,H={},w=!0,I=function(){return C(function(a){var c,e,f,g;if(c=a.data,"string"==typeof c){if(/^XDPING(_(V\d+))?$/.test(c)&&RegExp.$2!==d)return L("your master is not compatible with your slave, check your xdomain.js version");if(/^xdomain-/.test(c))c=c.split(",");else if(w)try{c=JSON.parse(c)}catch(h){return}}if(c instanceof Array&&(f=c.shift(),/^xdomain-/.test(f)&&(g=H[f],null!==g))){if(g===b){if(!s)return;g=k(f,a.source),s(a.origin,g)}e="string"==typeof c[1]?": '"+c[1]+"'":"",z("receive socket: "+f+": '"+c[0]+"'"+e),g.fire.apply(g,c)}})},k=function(a,b){var d,f,g,h,i,j;return i=!1,j=H[a]=N.EventEmitter(!0),j.id=a,j.once("close",function(){return j.destroy(),j.close()}),h=[],j.emit=function(){var b,c;b=G(arguments),c="string"==typeof b[1]?": '"+b[1]+"'":"",z("send socket: "+a+": "+b[0]+c),b.unshift(a),i?g(b):h.push(b)},g=function(a){w&&(a=JSON.stringify(a)),b.postMessage(a,"*")},j.close=function(){j.emit("close"),z("close socket: "+a),H[a]=null},j.once(e,function(b){for(w="string"==typeof b,i=j.ready=!0,j.emit("ready"),z("ready socket: "+a+" (emit #"+h.length+" pending)");h.length;)g(h.shift())}),f=0,d=function(){return function(){b.postMessage([a,e,{}],"*"),i||(f++>=M.timeout/c?(L("Timeout waiting on iframe socket"),n.fire("timeout"),j.fire("abort")):setTimeout(d,c))}}(this),setTimeout(d),z("new socket: "+a),j},i=function(a){var b;return b=k(r(),a)},x=function(a){s=a},N=(this.exports||this).xhook,M=function(a){a&&(a.masters&&g(a.masters),a.slaves&&h(a.slaves))},M.masters=g,M.master=f,M.slaves=h,M.debug=!1,M.timeout=15e3,c=100,m=a.document,y=a.location,l=M.origin=y.protocol+"//"+y.host,r=function(){return"xdomain-"+Math.round(Math.random()*Math.pow(2,32)).toString(16)},G=function(a,b){return Array.prototype.slice.call(a,b)},j=a.console||{},n=null,E=function(){n=N.EventEmitter(!0),M.on=n.on},N&&E(),A=function(a){return function(b){b="xdomain ("+l+"): "+b,n.fire(a,b),("log"!==a||M.debug)&&(a in M?M[a](b):a in j?j[a](b):"warn"===a&&alert(b))}},z=A("log"),L=A("warn"),Q=["postMessage","JSON"];for(O=0,P=Q.length;P>O;O++)if(o=Q[O],!a[o])return void L("requires '"+o+"' and this browser does not support it");v=function(b,c){return c in a?b instanceof a[c]:!1},d="V1",D=M.parseUrl=function(a){return/^((https?:)?\/\/[^\/\?]+)(\/.*)?/.test(a)?{origin:(RegExp.$2?"":y.protocol)+RegExp.$1,path:RegExp.$3}:(z("failed to parse absolute url: "+a),null)},K=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".*"),new RegExp("^"+b+"$"))},J=function(a){var b,c,d,e;b={};for(c in a)"returnValue"!==c&&(d=a[c],"function"!=(e=typeof d)&&"object"!==e&&(b[c]=d));return b},function(){var a,b,c,d,e,f,i,j,k,l,n;for(a={debug:function(a){return"string"==typeof a?M.debug="false"!==a:void 0},slave:function(a){var b,c;if(a&&(b=D(a)))return c={},c[b.origin]=b.path,h(c)},master:function(a){var b,c;if(a&&(c="*"===a?{origin:"*",path:"*"}:D(a)))return b={},b[c.origin]=c.path.replace(/^\//,"")?c.path:"*",g(b)}},l=m.getElementsByTagName("script"),f=0,j=l.length;j>f;f++)if(e=l[f],/xdomain/.test(e.src))for(n=["","data-"],i=0,k=n.length;k>i;i++){d=n[i];for(c in a)(b=a[c])(e.getAttribute(d+c))}}(),I(),"function"==typeof this.define&&this.define.amd?define("xdomain",["xhook"],function(a){return N=a,E(),M}):(this.exports||this).xdomain=M}).call(this,window);